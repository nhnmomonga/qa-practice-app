# 探索的テストセッション報告書

## セッション情報
- **テスト対象**: QA Practice App - 商品在庫管理システム
- **テスト実施日**: 2025-11-06
- **テスト実施者**: QA自動化エージェント
- **テスト目的**: 仕様書に記載された意図的なバグ以外の不具合を発見する
- **テスト時間**: 制限なし（徹底的な探索）

## テストチャーター
仕様書（README.md、PRD.md）に記載されている意図的なバグ（「バグ票」検索エラー、XSS脆弱性、削除確認ダイアログなし）を除外し、実装上の不具合を探索する。特に以下の観点を重視：
1. 入力バリデーションの不備
2. フォーム送信の問題
3. 権限制御の不備
4. データ整合性の問題
5. ユーザビリティ上の問題

## エグゼクティブサマリー

探索的テストにより、**2件の意図的でない不具合**を発見しました。

### 重要度別サマリー
- 🟡 **中**: 2件（検索バリデーション不備）
- 🟢 **低**: 0件

### 訂正履歴
- **2025-11-07**: Bug #4（商品登録フォームが送信不可）は誤報告でした。バックエンドで `status = '準備中'` とハードコードされているため、disabled属性のラジオボタンでも商品登録は正常に動作します。詳細は `検証結果_Bug4は誤報告.md` を参照。

## 発見された不具合詳細

### Bug #1: 検索フォームで負の価格値が受け入れられる

**重要度**: 🟡 中

**カテゴリ**: 入力バリデーション不備

**再現手順**:
1. ブラウザで `http://127.0.0.1:5000` にアクセス
2. 管理者またはユーザーでログイン
3. 商品一覧ページの検索フォームで「価格（下限）」に `-1` を入力
4. 「検索」ボタンをクリック

**期待される動作**:
- 価格は0円以上であるべきなので、負の値は受け入れるべきではない
- エラーメッセージを表示するか、入力を拒否すべき

**実際の動作**:
- 負の値を入力しても検索が実行される
- SQLクエリに `-1` が渡され、すべての商品が結果として表示される（price >= -1 はすべて真）

**技術的詳細**:
- 検索フォームの `<input type="number">` に `min="0"` 属性が設定されていない
- バックエンドでも負の値のバリデーションが行われていない
- 該当ファイル: `templates/products_list.html` 38-43行目、`app.py` 136-139行目

**影響**:
- ユーザーが無効な検索条件を指定でき、予期しない検索結果により混乱する可能性がある
- セキュリティリスクは低いが、UX（ユーザー体験）の観点で問題

**推奨修正**:
1. HTMLテンプレートの入力フィールドに `min="0"` 属性を追加
2. バックエンドで負の値が渡された場合のバリデーションを追加

```html
<!-- 修正例 -->
<input type="number" 
       id="price_min" 
       name="price_min" 
       data-testid="search-price-min"
       value="{{ request.args.get('price_min', '') }}"
       min="0"
       placeholder="例: 1000">
```

---

### Bug #2: 検索で price_min > price_max が許可される

**重要度**: 🟡 中

**カテゴリ**: ロジックバリデーション不備

**再現手順**:
1. ブラウザで商品一覧ページにアクセス
2. 検索フォームで：
   - 「価格（下限）」に `100` を入力
   - 「価格（上限）」に `50` を入力
3. 「検索」ボタンをクリック

**期待される動作**:
- 下限が上限より大きい場合、エラーメッセージを表示すべき
- または、自動的に値を入れ替えるべき
- 最低限、ユーザーに警告を表示すべき

**実際の動作**:
- 検索は実行されるが、論理的に不可能な条件（100円以上 AND 50円以下）のため結果は常に0件
- エラーメッセージやワーニングは表示されない
- URL: `http://127.0.0.1:5000/products?keyword=&category=&price_min=100&price_max=50`

**技術的詳細**:
- バックエンドで価格範囲の論理的整合性チェックが実装されていない
- SQLクエリ: `WHERE price >= 100 AND price <= 50` （常に偽）
- 該当ファイル: `app.py` 136-143行目

**影響**:
- ユーザーが意図しない検索結果（常に0件）を得て混乱する
- サポートへの問い合わせ増加の可能性
- ユーザビリティの低下

**推奨修正**:
バックエンドで価格範囲の検証を追加：

```python
# app.py に追加
if price_min and price_max:
    if int(price_min) > int(price_max):
        flash('価格の下限は上限以下である必要があります。', 'error')
        return redirect(url_for('products_list'))
```

---

### Bug #3: 在庫ステータス表示（確認結果：正常）

**状態**: ✅ 正常動作を確認

**検証内容**:
仕様書の在庫ステータス表示ルールが正しく実装されているか検証しました。

**仕様**:
- 在庫数 = 0: 「在庫切れ」（背景色: 赤）
- 1 ≤ 在庫数 ≤ 10: 「残りわずか」（背景色: 黄）
- 在庫数 > 10: 「在庫あり」（背景色なし）

**検証結果**:
| 商品 | 在庫数 | 表示 | 背景色 | 結果 |
|------|--------|------|--------|------|
| 有機野菜セット | 0個 | 在庫切れ | 赤 | ✅ |
| ビジネス書 | 3個 | 残りわずか | 黄 | ✅ |
| ワイヤレスマウス | 8個 | 残りわずか | 黄 | ✅ |
| お茶セット | 12個 | 在庫あり | なし | ✅ |
| コーヒー豆 | 25個 | 在庫あり | なし | ✅ |
| USB充電器 | 100個 | 在庫あり | なし | ✅ |

**結論**: この機能は仕様通りに正しく実装されています。

---

### ~~Bug #4: 商品新規登録フォームが送信できない~~ ❌ 誤報告

**⚠️ 訂正（2025-11-07）**: この報告は誤りでした。

**検証結果**: 商品登録は正常に動作します。

**誤報告の経緯**:
- 初回テスト時に Playwright でフォーム送信がうまく動作せず、「フォームが送信されない」と判断
- `disabled` 属性により `status` フィールドの値がフォーム送信に含まれないことを確認
- しかし、バックエンドの実装を十分に確認しなかった

**実際の実装**:
`app.py` の169行目で、フォームから送信される値を使用せず、常に `status = '準備中'` とハードコードされています。

```python
# app.py の product_new 関数（163行目〜）
if request.method == 'POST':
    name = request.form.get('name', '').strip()
    category = request.form.get('category')
    price = request.form.get('price')
    stock = request.form.get('stock')
    description = request.form.get('description', '')
    status = '準備中'  # ← フォームから値を取得せず、ハードコード
```

**再検証の結果**:
```python
# statusフィールドを含まないデータで商品登録
product_data = {
    'name': '検証テスト商品',
    'category': '家電',
    'price': '2500',
    'stock': '15',
    'description': 'テスト'
    # 'status' フィールドなし
}

# 結果
✅ 商品は正常に登録された
✅ ステータスは「準備中」で保存された
✅ データベースにも正しく記録された
```

**結論**:
- `disabled` 属性により `status` フィールドは送信されない → **正常な動作**
- バックエンドで `status = '準備中'` とハードコード → **フォームからの値不要**
- 商品登録は **正常に機能する**

**詳細**: `検証結果_Bug4は誤報告.md` を参照

---

## テスト実施範囲

### ✅ 実施したテスト項目

#### 1. 認証・認可機能
- ✅ 正常なログイン（admin / user）
- ✅ 不正なログイン試行（存在しないユーザー、間違ったパスワード）
- ✅ SQLインジェクション試行（`admin' OR '1'='1`）→ 対策済み
- ✅ ログアウト機能
- ✅ 未ログイン時のアクセス制御
- ✅ 権限による機能制限（user による新規登録・削除の禁止）

#### 2. 商品一覧・検索機能
- ✅ 商品一覧の表示
- ✅ 在庫ステータスの表示（在庫切れ、残りわずか、在庫あり）
- ✅ 検索フォームの動作
- ✅ 境界値テスト（負の価格、逆転した価格範囲）
- ✅ 検索結果が0件の場合の表示

#### 3. 商品登録機能
- ✅ 新規登録フォームへのアクセス
- ✅ 必須項目の確認
- ✅ 境界値テスト（価格1,000,000円、在庫999個）
- ✅ 無効な値の入力試行（小数値）
- 🔴 **フォーム送信の動作（Bug #4 発見）**

#### 4. 商品編集機能
- ✅ 編集フォームへのアクセス
- ✅ 存在しない商品IDへのアクセス→ エラーハンドリング正常
- ✅ ステータス遷移ルールの確認（UI表示）

#### 5. エラーハンドリング
- ✅ 存在しない商品へのアクセス
- ✅ 権限エラーの表示
- ✅ バリデーションエラーの表示（小数値入力時）

### ⏸️ 未実施のテスト項目（今後のテスト候補）

- ステータス遷移の全パターン（準備中→公開中、公開中→非公開など）
- 商品削除機能の詳細テスト
- 並行編集・競合状態のテスト
- 大量データでのパフォーマンステスト
- ブラウザ互換性テスト
- モバイルレスポンシブデザインのテスト
- 長時間セッションの動作確認
- 特殊文字・絵文字の入力テスト
- ファイルアップロード機能（存在しないが将来的に）

## 正常に動作している機能

以下の機能は仕様通りに正しく動作していることを確認しました：

✅ **認証システム**
- ログイン・ログアウトが正常に動作
- SQLインジェクション対策が実装されている
- セッション管理が適切

✅ **権限制御**
- admin と user の権限分離が正しく実装
- 直接URLアクセスでも権限チェックが機能

✅ **在庫ステータス表示**
- 仕様通りの条件分岐とスタイル適用

✅ **バリデーション**
- 商品名の文字数制限（maxlength="50"）
- 価格・在庫数の範囲チェック（編集時）
- 型チェック（整数のみ受付）

✅ **エラーハンドリング**
- 存在しない商品への適切な対応
- 権限エラーの適切な表示

## テストメトリクス

| 項目 | 値 |
|------|-----|
| テスト実施項目数 | 25+ |
| 発見されたバグ数（意図的でない） | 2件（訂正前：4件） |
| 重大バグ数 | 0件（訂正前：1件） |
| 誤報告数 | 1件（Bug #4） |
| 検証済みページ数 | 4ページ |
| 検証済みユーザーロール数 | 2種類 |
| テストデータ数 | 8商品 + 4追加（検証用含む） |

## リスク評価

### 技術的リスク
- 🟡 **中**: 検索バリデーション不備によるUX低下

### ビジネスリスク
- 🟢 **低**: 既存商品の閲覧・編集・登録は正常に動作

### ユーザビリティリスク
- 🟡 **中**: 検索機能の直感性が低く、ユーザーが混乱する可能性

## 推奨される対応優先順位

### 📌 P1（高 - 1週間以内に対応）
1. **Bug #1: 検索フォームのバリデーション追加**
   - 推定工数: 1時間
2. **Bug #2: 価格範囲の論理チェック追加**
   - 推定工数: 1時間

### 📋 P2（中 - 次回リリースで対応）
4. ステータス遷移の包括的なテスト実施
5. 並行編集のテスト実施

## 付録

### テスト環境
- **OS**: Linux
- **ブラウザ**: Playwright (Chromium)
- **Python**: 3.x
- **Flask**: 3.0.0
- **データベース**: SQLite

### 参照ドキュメント
- README.md
- PRD.md（製品要求仕様書）
- templates/*.html
- app.py

### スクリーンショット
テスト実施中に取得したスクリーンショットは以下のGitHub URLで参照可能：
1. ログインページ
2. 商品一覧ページ
3. 商品登録フォーム
4. 商品編集フォーム
5. Bug #4 確認時の画面

---

**レポート作成日**: 2025-11-06  
**次回テスト予定**: Bug修正後の回帰テスト
